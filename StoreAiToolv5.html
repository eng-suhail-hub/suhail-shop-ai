<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Famelo Ultimate System | نظام المعالجة المتكامل</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #d63384; --secondary: #1e293b; --bg: #f1f5f9; --card: #ffffff;
            --success: #10b981; --error: #ef4444; --warning: #f59e0b; --info: #3b82f6;
        }
        * { box-sizing: border-box; outline: none; transition: all 0.2s ease; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: #334155; }

        /* --- Sidebar --- */
        .sidebar { width: 400px; background: var(--card); border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; z-index: 1000; box-shadow: 4px 0 15px rgba(0,0,0,0.05); }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 25px; }
        .sidebar-footer { padding: 20px; background: #f8fafc; border-top: 1px solid #e2e8f0; }

        .menu-toggle { display: none; position: fixed; bottom: 25px; left: 25px; z-index: 2000; background: var(--primary); color: white; width: 55px; height: 55px; border-radius: 50%; box-shadow: 0 4px 15px rgba(214,51,132,0.4); border: none; cursor: pointer; font-size: 1.2rem; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; backdrop-filter: blur(2px); }

        @media (max-width: 1024px) {
            .sidebar { position: fixed; right: -100%; top: 0; height: 100%; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 85%; }
            .sidebar.open { right: 0; }
            .overlay.open { display: block; }
            .menu-toggle { display: block; }
        }

        /* --- Fields --- */
        h2 { color: var(--primary); margin: 0 0 20px 0; font-size: 1.4rem; border-bottom: 2px solid #fbcfe8; padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        h3 { font-size: 0.95rem; color: #64748b; margin-top: 25px; display: flex; align-items: center; gap: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .field { margin-bottom: 15px; }
        .field label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 6px; color: #475569; }
        .field input, .field select, .field textarea { width: 100%; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.9rem; background: #fff; }
        .field input:focus, .field textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(214, 51, 132, 0.1); }
        .input-group { display: flex; gap: 10px; }
        
        /* --- Main Area --- */
        .main { flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        
        /* Progress Header */
        .status-header { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 20px; }
        .p-bar-track { width: 100%; height: 10px; background: #f1f5f9; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .p-bar-fill { height: 100%; background: linear-gradient(90deg, var(--primary), #f472b6); width: 0%; transition: width 0.4s ease; }

        /* Drop Zone */
        .drop-zone { border: 2.5px dashed #cbd5e1; background: white; padding: 40px; border-radius: 16px; text-align: center; cursor: pointer; margin-bottom: 30px; transition: 0.3s; }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--primary); background: #fdf2f8; transform: translateY(-2px); }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { position: relative; background: white; border-radius: 12px; overflow: hidden; height: 180px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); cursor: pointer; border: 2px solid transparent; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .card.done { border-color: var(--success); }
        .card.error { border-color: var(--error); }
        .card.active { border-color: var(--warning); }

        /* Circular Progress (Per Image) */
        .overlay-loader { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; backdrop-filter: blur(2px); z-index: 10; }
        .ring { transform: rotate(-90deg); }
        .ring-circle { transition: stroke-dashoffset 0.2s linear; }
        .pct-label { position: absolute; font-size: 12px; font-weight: bold; }
        .status-badge { font-size: 10px; margin-top: 8px; background: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 10px; }

        /* Logs */
        #log-area { background: #0f172a; color: #10b981; font-family: 'Consolas', monospace; font-size: 11px; padding: 15px; border-radius: 12px; height: 160px; overflow-y: auto; margin-top: auto; border: 1px solid #1e293b; }
        .log-row { margin-bottom: 4px; border-bottom: 1px solid #1e293b; padding-bottom: 2px; }
        .log-err { color: #f87171; } .log-info { color: #60a5fa; } .log-sys { color: #fbbf24; }

        /* Buttons */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; color: white; font-size: 1rem; }
        .btn-primary { background: var(--primary); box-shadow: 0 4px 10px rgba(214,51,132,0.2); }
        .btn-success { background: var(--success); }
        .btn-info { background: var(--info); }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; box-shadow: none; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: white; width: 100%; max-width: 650px; border-radius: 16px; overflow: hidden; max-height: 90vh; display: flex; flex-direction: column; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Export Panel */
        .export-panel { display: none; background: white; border: 2px solid var(--success); padding: 25px; border-radius: 16px; margin-bottom: 25px; text-align: center; }
        .export-opts { display: flex; gap: 15px; justify-content: center; margin-top: 15px; flex-wrap: wrap; }

    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <div class="overlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <h2><i class="fas fa-cogs"></i> إعدادات النظام</h2>
            
            <div class="field">
                <label>Gemini API Key</label>
                <input type="password" id="cfg_apiKey" placeholder="AIzaSy..."
                value="AIzaSyBof99Mrrzt7RhN9uf1vcGurUBi9bisCYE" onchange="saveConfig()">
            </div>
            
            <div class="field">
                <label>AI Model</label>
                <select id="cfg_model" onchange="saveConfig()">
                    <option value="gemini-3-flash-preview">Gemini 3 Flash Preview (Fast)</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro (Accurate)</option>
                </select>
            </div>

            <h3><i class="fas fa-pen-nib"></i> المحتوى والبيانات</h3>
            <div class="field">
                <label>Prompt (التعليمات)</label>
                <textarea id="cfg_prompt" rows="3" onchange="saveConfig()">حلل الصورة واستخرج بيانات المنتج.</textarea>
            </div>
            <div class="field">
                <label>JSON Structure</label>
                <textarea id="cfg_json" rows="7" onchange="saveConfig()">{
  "الاسم": "اسم المنتج",
  "SKU": "كود مخصص",
  "السعر": 0,
  "الوصف المختصر": "وصفةلا يتجاوز سطرين",
  "الوصف": "وصف كامل",
  "الاسم الميتا": "اسم في metadata لتحسين SEO",
  "الوصف الميتا": "وصف metadata ل seo"
}</textarea>
            </div>

            <h3><i class="fas fa-image"></i> الصور</h3>
            <div class="field">
                <label>مسار الصور (Server Path)</label>
                <input type="text" id="cfg_path" value="catalog/products/" onchange="saveConfig()">
            </div>
            <div class="field">
                <label>تسمية الصور (Input Naming)</label>
                <select id="cfg_imgNaming" onchange="toggleImgRegex(); saveConfig()">
                    <option value="original">Original Name</option>
                    <option value="regex">Regex / Prefix</option>
                </select>
            </div>
            <div class="field" id="wrap_imgRegex" style="display:none;">
                <label>Expression (Use {i} for index)</label>
                <input type="text" id="cfg_imgRegexVal" value="prod_{i}" onchange="saveConfig()">
            </div>

            <h3><i class="fas fa-magic"></i> التوليد (Gen AI)</h3>
            <div class="field">
                <label>توليد صور إضافية؟</label>
                <select id="cfg_genEnable" onchange="toggleGenCount(); saveConfig()">
                    <option value="no">لا</option>
                    <option value="yes">نعم</option>
                </select>
            </div>
            <div class="field" id="wrap_genCount" style="display:none;">
                <label>عدد الصور</label>
                <input type="number" id="cfg_genCount" value="1" min="1" max="4" onchange="saveConfig()">
            </div>

            <h3><i class="fas fa-file-export"></i> المخرجات</h3>
            <div class="field">
                <label>قاعدة تسمية الملف (Result File)</label>
                <input type="text" id="cfg_outRule" value="results_{date}" onchange="saveConfig()">
            </div>
        </div>
        
        <div class="sidebar-footer">
            <button class="btn btn-info" onclick="resetConfig()"><i class="fas fa-undo"></i> استعادة الافتراضي</button>
        </div>
    </aside>

    <main class="main">
        <div class="status-header">
            <div style="display:flex; justify-content:space-between; font-weight:bold; color:#64748b;">
                <span id="lbl_status">النظام جاهز...</span>
                <span id="lbl_pct">0%</span>
            </div>
            <div class="p-bar-track">
                <div class="p-bar-fill" id="bar_fill"></div>
            </div>
        </div>

        <div class="drop-zone" id="dropZone">
            <i class="fas fa-cloud-upload-alt fa-3x" style="color:#cbd5e1; margin-bottom:15px;"></i>
            <h3>اسحب المجلدات أو الصور هنا</h3>
            <p style="color:#94a3b8;">سيتم عرض البطاقات فور التحميل</p>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none;">
        </div>

        <div class="grid" id="grid"></div>

        <div style="margin-bottom: 20px;">
            <button id="btn_start" class="btn btn-primary" disabled onclick="startProcessing()">
                <i class="fas fa-play"></i> بدء المعالجة
            </button>
        </div>

        <div class="export-panel" id="exportPanel">
            <h3 style="margin:0; justify-content:center; color:var(--success);"><i class="fas fa-check-circle"></i> اكتملت المهمة!</h3>
            <div class="export-opts">
                <div class="field" style="margin:0; text-align:right;">
                    <label>اسم الملف النهائي</label>
                    <input type="text" id="final_outName">
                </div>
                <div class="field" style="margin:0; text-align:right;">
                    <label>الصيغة</label>
                    <select id="final_outType">
                        <option value="xlsx">Excel (.xlsx)</option>
                        <option value="csv">CSV (.csv)</option>
                    </select>
                </div>
                <button class="btn btn-success" style="width:auto;" onclick="generateAndDownload()">
                    <i class="fas fa-download"></i> توليد وتحميل
                </button>
            </div>
        </div>

        <div id="log-area"><div class="log-row">> سجل النظام بدأ...</div></div>
    </main>

    <div class="modal" id="modal">
        <div class="modal-box">
            <div style="padding:15px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:#f8fafc;">
                <h3 style="margin:0;">نتائج المعالجة</h3>
                <button onclick="document.getElementById('modal').style.display='none'" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div id="modalBody" style="overflow-y:auto; padding:0;"></div>
        </div>
    </div>

<script>
    // --- STATE ---
    let filesData = [];    // { file, processed, result, id }
    let globalResults = []; // Final data for export
    
    // --- DOM REFERENCES ---
    const grid = document.getElementById('grid');
    const logArea = document.getElementById('log-area');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    // --- INITIALIZATION ---
    window.onload = () => {
        loadConfig();
        log("تم تحميل الإعدادات من الذاكرة المحلية.", "sys");
    };

    // --- CONFIG & STORAGE ---
    const CONFIG_IDS = ['cfg_apiKey', 'cfg_model', 'cfg_prompt', 'cfg_json', 'cfg_path', 'cfg_imgNaming', 'cfg_imgRegexVal', 'cfg_genEnable', 'cfg_genCount', 'cfg_outRule'];

    function saveConfig() {
        const data = {};
        CONFIG_IDS.forEach(id => data[id] = document.getElementById(id).value);
        localStorage.setItem('famelo_config_v8', JSON.stringify(data));
        log("تم حفظ التعديلات.", "info");
    }

    function loadConfig() {
        const saved = localStorage.getItem('famelo_config_v8');
        if(saved) {
            const data = JSON.parse(saved);
            CONFIG_IDS.forEach(id => {
                if(data[id]) document.getElementById(id).value = data[id];
            });
            toggleImgRegex();
            toggleGenCount();
        }
    }

    function resetConfig() {
        if(confirm("هل أنت متأكد من استعادة الإعدادات الافتراضية؟")) {
            localStorage.removeItem('famelo_config_v8');
            location.reload();
        }
    }

    function toggleImgRegex() {
        document.getElementById('wrap_imgRegex').style.display = 
            document.getElementById('cfg_imgNaming').value === 'regex' ? 'block' : 'none';
    }

    function toggleGenCount() {
        document.getElementById('wrap_genCount').style.display = 
            document.getElementById('cfg_genEnable').value === 'yes' ? 'block' : 'none';
    }

    // --- UI HELPERS ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.querySelector('.overlay').classList.toggle('open');
    }

    function log(msg, type='') {
        const div = document.createElement('div');
        div.className = `log-row log-${type}`;
        div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logArea.appendChild(div);
        logArea.scrollTop = logArea.scrollHeight;
    }

    // --- FILE HANDLING (RECURSIVE) ---
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = () => handleFiles(Array.from(fileInput.files));
    
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = async (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const items = e.dataTransfer.items;
        let files = [];
        
        async function traverse(entry) {
            if (entry.isFile) {
                const f = await new Promise(r => entry.file(r));
                if(f.type.startsWith('image/')) files.push(f);
            } else if (entry.isDirectory) {
                const reader = entry.createReader();
                const entries = await new Promise(r => reader.readEntries(r));
                for(const en of entries) await traverse(en);
            }
        }
        for (const item of items) {
            if (item.webkitGetAsEntry) await traverse(item.webkitGetAsEntry());
        }
        handleFiles(files);
    };

    function handleFiles(files) {
        if(files.length === 0) return;
        
        // Reset Logic
        grid.innerHTML = '';
        filesData = [];
        globalResults = [];
        document.getElementById('exportPanel').style.display = 'none';
        
        files.forEach((f, i) => {
            filesData.push({ file: f, processed: false, id: i });
            createCard(f, i);
        });

        document.getElementById('btn_start').disabled = false;
        log(`تم إدراج ${files.length} صورة بنجاح.`, "info");
    }

    function createCard(file, id) {
        const div = document.createElement('div');
        div.className = 'card';
        div.id = `card-${id}`;
        div.onclick = () => showDetails(id);
        
        // Initial HTML with Loader Hidden
        div.innerHTML = `
            <img src="${URL.createObjectURL(file)}" alt="preview">
            <div class="overlay-loader" id="loader-${id}">
                <div style="position:relative; width:50px; height:50px;">
                    <svg class="ring" width="50" height="50">
                        <circle cx="25" cy="25" r="20" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="4"></circle>
                        <circle id="circle-${id}" class="ring-circle" cx="25" cy="25" r="20" fill="none" stroke="var(--primary)" stroke-width="4" stroke-dasharray="126" stroke-dashoffset="126"></circle>
                    </svg>
                    <div class="pct-label" id="pct-${id}">0%</div>
                </div>
                <div class="status-badge" id="badge-${id}">قراءة...</div>
            </div>
        `;
        grid.appendChild(div);
    }

    // --- PROCESSING ENGINE ---
    async function startProcessing() {
        const apiKey = document.getElementById('cfg_apiKey').value;
        if(!apiKey) return alert("الرجاء إدخال API Key في القائمة الجانبية");

        document.getElementById('btn_start').disabled = true;
        log("بدأت عملية المعالجة...", "sys");

        for (let i = 0; i < filesData.length; i++) {
            const item = filesData[i];
            const card = document.getElementById(`card-${item.id}`);
            const loader = document.getElementById(`loader-${item.id}`);
            
            // Activate Card
            card.classList.add('active');
            loader.style.display = 'flex';
            
            try {
                // 1. Read File (0-10%)
                updateCardProgress(item.id, 5, "تحميل..");
                const base64 = await readFile(item.file, (p) => {
                    updateCardProgress(item.id, Math.floor(p * 0.1), "قراءة..");
                });

                // 2. Upload to AI (10-80%) - Real XHR
                updateCardProgress(item.id, 10, "رفع..");
                const aiResponse = await callGeminiXHR(apiKey, base64, (p) => {
                    const total = 10 + Math.floor(p * 0.7); // Map 0-100 to 10-80
                    updateCardProgress(item.id, total, "رفع AI..");
                });

                // 3. Image Generation Simulation (If enabled)
                if(document.getElementById('cfg_genEnable').value === 'yes') {
                    updateCardProgress(item.id, 85, "توليد..");
                    await simulateImageGen(document.getElementById('cfg_genCount').value);
                    log(`تم طلب توليد صور للملف ${item.file.name}`, "info");
                }

                // 4. Processing Done (100%)
                updateCardProgress(item.id, 100, "اكتمل");
                
                // 5. Format Data
                const finalData = processFinalData(item.file, aiResponse, i);
                filesData[i].result = finalData;
                globalResults.push(finalData);

                // UI Success State
                card.classList.remove('active');
                card.classList.add('done');
                setTimeout(() => loader.style.display = 'none', 500);
                log(`نجاح: ${item.file.name}`, "success");

            } catch (err) {
                card.classList.remove('active');
                card.classList.add('error');
                updateCardProgress(item.id, 0, "فشل");
                log(`خطأ في ${item.file.name}: ${err}`, "err");
            }

            // Update Overall Linear Bar
            const totalPct = Math.round(((i + 1) / filesData.length) * 100);
            document.getElementById('bar_fill').style.width = `${totalPct}%`;
            document.getElementById('lbl_pct').innerText = `${totalPct}%`;
            document.getElementById('lbl_status').innerText = `تمت معالجة ${i+1} من ${filesData.length}`;
        }

        finishWorkflow();
    }

    // --- WORKFLOW HELPERS ---
    function updateCardProgress(id, pct, text) {
        const circle = document.getElementById(`circle-${id}`);
        const label = document.getElementById(`pct-${id}`);
        const badge = document.getElementById(`badge-${id}`);
        
        // SVG Circumference ~ 126
        const offset = 126 - (pct / 100) * 126;
        circle.style.strokeDashoffset = offset;
        label.innerText = `${pct}%`;
        if(text) badge.innerText = text;
    }

    function readFile(file, onProgress) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onprogress = (e) => {
                if (e.lengthComputable) onProgress((e.loaded / e.total) * 100);
            };
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function callGeminiXHR(key, base64, onUploadProgress) {
        return new Promise((resolve, reject) => {
            const model = document.getElementById('cfg_model').value;
            const prompt = document.getElementById('cfg_prompt').value;
            const jsonStruct = document.getElementById('cfg_json').value;

            const xhr = new XMLHttpRequest();
            xhr.open("POST", `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`);
            xhr.setRequestHeader("Content-Type", "application/json");

            // Real Upload Tracking
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) onUploadProgress((e.loaded / e.total) * 100);
            };

            // On Load (Waiting for Response)
            xhr.onloadstart = () => onUploadProgress(100); // Upload done, now waiting

            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const res = JSON.parse(xhr.responseText);
                        if(res.error) reject(res.error.message);
                        const txt = res.candidates[0].content.parts[0].text;
                        resolve(JSON.parse(txt.replace(/```json|```/g, "")));
                    } catch (e) { reject("JSON Parse Error"); }
                } else reject(`API Error ${xhr.status}`);
            };
            xhr.onerror = () => reject("Network Error");

            const body = JSON.stringify({
                contents: [{
                    parts: [
                        { text: `${prompt}\nOutput JSON ONLY:\n${jsonStruct}` },
                        { inline_data: { mime_type: "image/jpeg", data: base64.split(',')[1] } }
                    ]
                }]
            });
            xhr.send(body);
        });
    }

    function simulateImageGen(count) {
        return new Promise(resolve => {
            // Fake delay for image generation (1s per image)
            setTimeout(resolve, count * 1000);
        });
    }

    function processFinalData(file, aiJson, index) {
        // Apply Image Naming Rule
        const namingMode = document.getElementById('cfg_imgNaming').value;
        const prefix = document.getElementById('cfg_imgRegexVal').value;
        const ext = file.name.split('.').pop();
        
        let finalName = file.name;
        if (namingMode === 'regex') {
            finalName = prefix.replace('{i}', index + 1) + '.' + ext;
        }

        // Apply Server Path
        const serverPath = document.getElementById('cfg_path').value;
        
        return {
            ...aiJson,
            image_name: finalName,
            full_path: serverPath + finalName
        };
    }

    function finishWorkflow() {
        log("اكتملت جميع العمليات.", "success");
        const outRule = document.getElementById('cfg_outRule').value;
        const finalName = outRule.replace('{date}', new Date().toISOString().split('T')[0]);
        
        document.getElementById('final_outName').value = finalName;
        document.getElementById('exportPanel').style.display = 'block';
        document.getElementById('btn_start').disabled = false;
        document.getElementById('btn_start').innerHTML = '<i class="fas fa-redo"></i> معالجة جديدة';
    }

    // --- RESULTS & EXPORT ---
    function showDetails(id) {
        const item = filesData.find(f => f.id === id);
        if(!item || !item.result) return;

        const body = document.getElementById('modalBody');
        let html = `
            <div style="text-align:center; padding:15px; background:#f1f5f9;">
                <img src="${URL.createObjectURL(item.file)}" style="height:150px; border-radius:10px; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
            </div>
            <table style="width:100%; border-collapse:collapse;">
        `;
        
        for (const [key, val] of Object.entries(item.result)) {
            html += `
                <tr>
                    <td style="padding:12px; border-bottom:1px solid #eee; font-weight:bold; color:#64748b; width:30%;">${key}</td>
                    <td style="padding:12px; border-bottom:1px solid #eee;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="word-break:break-all;">${val}</span>
                            <button onclick="navigator.clipboard.writeText('${val}')" style="border:none; background:#e2e8f0; padding:5px 10px; border-radius:6px; cursor:pointer;"><i class="fas fa-copy"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }
        html += `</table>`;
        body.innerHTML = html;
        document.getElementById('modal').style.display = 'flex';
    }

    function generateAndDownload() {
        if(globalResults.length === 0) return alert("لا توجد نتائج!");
        
        const type = document.getElementById('final_outType').value;
        const name = document.getElementById('final_outName').value;

        if (type === 'xlsx') {
            const ws = XLSX.utils.json_to_sheet(globalResults);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Famelo_Data");
            XLSX.writeFile(wb, `${name}.xlsx`);
        } else {
            const keys = Object.keys(globalResults[0]);
            let csv = "\uFEFF" + keys.join(",") + "\n";
            globalResults.forEach(row => {
                csv += keys.map(k => `"${String(row[k] || '').replace(/"/g, '""')}"`).join(",") + "\n";
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}.csv`;
            a.click();
        }
        log(`تم تحميل الملف: ${name}.${type}`, "success");
    }

</script>
</body>
</html>
